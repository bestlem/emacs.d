#+PROPERTY:header-args :cache yes :tangle yes :comments link

* Global key bindings
This file manages my global  key bindings excpet in Aquamacs they are not global.
Other files might have defined global keys e.g. to start particular modes,  but in general we want them here.

** How to bind
The obvious is global key but......Aquamacs has added a map or two mainly to provide the command keys e.g. ‚åòS so [[https://www.emacswiki.org/emacs/AquamacsFAQ#toc13][Aquamacs FAQ]]  suggest (define-key osx-key-mode-map (kbd "H-t") 'treemacs) to alter the OSX map.

This [[https://stackoverflow.com/a/27441815/151019][Stack Overlow answer]] suggests use of bind-key  if we do not want to be overridden.

ALso see [[https://github.com/noctuid/general.el][General package]] but see [[https://github.com/noctuid/general.el/issues/10][comparison]] with bind-key from use package so stick to bind

*** TODO Replace the key definition functions with a mwb one that can switch between global-key and the Aquamacs way
Use bond-key
** Keyboard Thoughts

*** History
I used Teletypes at some stage in the beginning or at least very clicky keyboards. My first professional and heavy programming was in APL so I am used to odd layouts (IBM 3279 although this [[https://www.google.com/imgres?imgurl=https%3A%2F%2Flive.staticflickr.com%2F1671%2F25859890091_f7e9173891_b.jpg&imgrefurl=https%3A%2F%2Fwww.flickr.com%2Fphotos%2F22368471%40N04%2F25859890091&docid=ZLVoX24MY-4ACM&tbnid=ZUP2S6AC-ynJIM%3A&vet=10ahUKEwi32JONrMDmAhVOQhUIHV8UCAEQMwhOKAAwAA..i&w=1023&h=445&bih=872&biw=1298&q=apl%20keyboard&ved=0ahUKEwi32JONrMDmAhVOQhUIHV8UCAEQMwhOKAAwAA&iact=mrc&uact=8][one]] looks more like it) and clicky keys. My DOS editor was microemacs so learn some of the control xs xc and c-ae.

This is really the main piece of Emacs customization I have done over the years. I do not have full history before 2008 which is for Aquamacs and by that stage I had forgotten what all the key definitions were. The rcs log was from 2002 and that was 1.1.1.17 so quite a bit there but even that would have been a conversion to OSX, from my work using NT and  Sun (Linux was all server) and a NeXT PC.

I then read about keyboards especially from Xah Lee and came across the [[http://xahlee.info/kbd/i/NeXT_adb_keyboard_87366.jpg][NeXT adb keyboard for Pizza Box NeXT]] which I then realised is what I used and was where I really started to use Emacs. Note the command key is a bar below space and the keys are Help Alt going out from the space. So I used command as a binding and Help.
These keys are what the \?H bindings were and I had forgotten and probably removed a lot of those as I did not understand them. I also forgot what use the <return> and C-m choices were for. See [[http://ergoemacs.org/emacs/emacs_key_notation_return_vs_RET.html][Xah Lee "<return>" and "RET"]]
 "<return>" is the Return key while emacs runs in a graphical user interface.
 "RET" is the Return key while emacs runs in a terminal.
 "RET" is also equivalent to "C-m" („ÄêCtrl+m„Äë). (For why, see: [[http://ergoemacs.org/emacs/keystroke_rep.html][Emacs's Key Syntax Explained]])

*** Function keys
Muscle memory has a lot to answer for.
The first app that I which had useful function keys wa Visual C (The IBM had it but most programming was on Micro APL and I forget what that was)
The lasted MS [[https://docs.microsoft.com/en-us/visualstudio/ide/default-keyboard-shortcuts-for-frequently-used-commands-in-visual-studio?view=vs-2019][document]] lists them. f5 is the one I remember and that now does Debug.Start, which I think does a build then runs the debugger so that was my main hit and go key. Nowadays my usual task is build and run tests and debug only if needed. So change f5. The debug steps are f10 and f11 but can't see a continue, I include f12 there. f8 is Edit.GoToNextLocation so fits with my next error. But the NeXT suggestion looks like f7 and 8 (well equivalent) so the next error got shifted.

*** Keyboard usage.
Following Xah Lee's comments and seeing [[http://xahlee.info/kbd/space-cadet_keyboard.html][The Space Cadet Keyboard]] which is what emacs was implemented on and they keys outwards of space are control, Meta, Special and Hyper. SO I tried bindin so it went control, meta, super and caps lock as hyper but I am too used to the Apple bindinhg so went back to Command, Meta and control with caps lock as hyper (and right Windows key). However the control key is difficult to hit.

**** TODO Xah Lee bracket binding
Alt-J etc as suggested [[http://xahlee.info/kbd/best_way_to_insert_brackets.html][here]]

**** Typing style
I can't touch type but seem to have two modes. One is two or more finger for text. Then a mode switch to alter things where I have a right hand on the mouse and left with thumb on ‚åò, little finger near caps lock, next on a etc. Thus ‚åòzxcvasd are easy most of those are Apple keys, similarly the alt versions are OK but emacs does use that. The control ones are difficult. The Hyper ones are OK.
I discovered [[https://github.com/abo-abo/hydra][Hydra Mode]] which allows you to define keys and a menu to show what they do. I realised that for a new to me mode I could bind the most interesting functions to a hydra to help me learn what the mode does and also cut down on control-C (That's interrupt, isn't it ü§£must bind control-C to control-G as I have wanted that for ages)

So hyper-A is now a mode hydra key and I have started defining a hydra on that,

* Implementation

** Which Key
   Package [[https://github.com/justbur/emacs-which-key][which-key]] shows after a key press what you can do next (not useful for control-C as there are too many to show and you can't scroll).
   #+begin_src emacs-lisp
   (use-package which-key
     :ensure t
     :defer 5
     :config
     (which-key-setup-side-window-right-bottom)
     (setq which-key-sort-order 'which-key-key-order-alpha
           which-key-side-window-max-width 0.33
           which-key-idle-delay 0.05)
     (which-key-mode)
     :diminish which-key-mode)
   #+end_src
** Mac modifier key Bindings
We have fn available so have it as hyper and then use Karabiner  (try iCue later) to map Caps Lock and Window key to hyper. Super is used sometimes so I think is confusing and as noted sequence of keys (emacs key-chord and hydra) is better.
I don't use the right hand modifier keys so not set separately.
#+begin_src emacs-lisp
	 (setq ns-function-modifier 'hyper)
#+end_src
*** Display in help and menus
Note that you can control what the screen displays A for Alt or ‚å•. Emacs is not that clever and looks at what it is told and not what appears on the key but I am back to the normal bindings so does not matter. Although hydra seems to object. Set the value to non=nil to use Mac symbols.
#+begin_src emacs-lisp
	(setq ns-use-mac-modifier-symbols  t)
#+end_src
*** Home/End/Paging
 #+begin_src emacs-lisp
 ;;(define-key osx-key-mode-map [C-end] 'end-of-buffer )
 (bind-key [C-home] 'beginning-of-buffer osx-key-mode-map)
 (bind-key [C-kp-end] 'end-of-buffer osx-key-mode-map)
 (bind-key [C-kp-home] 'beginning-of-buffer osx-key-mode-map)
 (bind-key [S-kp-next] 'scroll-other-window-down osx-key-mode-map)
 (bind-key [S-kp-prior] 'scroll-other-window osx-key-mode-map)

 ;; Apple
 ;; Aquamacs thinks the insert key is <help>
 (bind-key [S-kp-delete] 'cua-cut-region)
 ;; Cocoa emacs does not recognise this key
 (bind-key [S-kp-insert] 'cua-paste)
 (bind-key [C-kp-insert] 'cua-copy-region)

 ;; Aquamacs defaults these to same
 ;;(bind-key [C-end] 'end-of-buffer )
 ;;(bind-key [C-home] 'beginning-of-buffer )

 ;; Unknown
 (bind-key [C-kp-end] 'end-of-buffer )
 (bind-key [C-kp-home] 'beginning-of-buffer )
 (bind-key [S-kp-next] 'scroll-other-window-down )
 (bind-key [S-kp-prior] 'scroll-other-window )

 ;(bind-key [s-left] 'scroll-left)
 ;(bind-key [s-right] 'scroll-right)


#+end_src

** Deleting and return
  #+begin_src emacs-lisp
  ;; (bind-key [C-return] 'newline-and-indent )
  ;;(bind-key [?\M-left] 'scroll-left )
  ;;(bind-key [C-backspace] 'backward-delete-char-untabify )
  (bind-key "<kp-delete>" 'delete-char )
  (bind-key "<backspace>" 'backward-delete-char-untabify)
  ;;(bind-key [?\A-backspace] 'undo )
  #+end_src
** Goto line
Now these are very old
  #+begin_src emacs-lisp
  (bind-key (kbd "M-g") 'goto-line)
  (bind-key (kbd "A-u") 'revert-buffer )
#+end_src
** Let search continue with arrows
DISABLED
But point seems to be messed up and does Aquamacs do something.
[[http://ergoemacs.org/emacs/emacs_isearch_by_arrow_keys.html][Xah Lee  again]] set arrow keys in isearch. left/right is backward/forward, up/down is history. press Return to exit
How does this work with ivy
#+begin_src emacs-lisp :tangle no

(progn
  ;; (define-key isearch-mode-map (kbd "<up>") 'isearch-ring-retreat )
  ;; (define-key isearch-mode-map (kbd "<down>") 'isearch-ring-advance )

  (define-key isearch-mode-map (kbd "<left>") 'isearch-repeat-backward)
  (define-key isearch-mode-map (kbd "<right>") 'isearch-repeat-forward)

  (define-key minibuffer-local-isearch-map (kbd "<left>") 'isearch-reverse-exit-minibuffer)
  (define-key minibuffer-local-isearch-map (kbd "<right>") 'isearch-forward-exit-minibuffer))
#+end_src
*** TODO Use with cmd-F
Aquamacs also messes around with isearch and the two don't exactly match. Which might be a good thing
** Function keys
Originally fit in with Visual C 6 (or earlier) keys. F1 help and can't redo in emacs. Just discovered that GNU say what F1-4 should be and seemed good for keyboard macros not my F7.
#+begin_src emacs-lisp
;; (bind-key [f3] 'gdb)
;; (bind-key [f4] 'grep )
(bind-key [f5] 'compile)
(bind-key [S-f4] 'grep)
;; These are the VC6 ones - not used for 15 years so could learn new ones,
;; (bind-key [kp-f3] 'gdb)
;; (bind-key [f12] 'gud-step )
;; (bind-key [f11] 'gud-next )
;; (bind-key [C-f10] 'gud-cont )
;; (bind-key [f10] 'gud-finish )
;; (bind-key [C-f11] 'gud-break )
;; (bind-key [C-f12] 'gud-tbreak )

;;  More VC6 keys
;; (bind-key [S-f7] 'next-error)
;; (bind-key [S-f8] 'previous-error)

;; But makes more sense to quickly hit a key
(bind-key [f8] 'next-error)
(bind-key [S-f8] 'previous-error)
#+end_src
** Old bindings
These will be old NeXT Pizza bindings


	 ;(global-set-key [?\A-=] 'what-line )
	 ;(global-set-key [?\M-g] 'goto-line)
	 ;(global-set-key [?\A-g] 'goto-line)
	 ;(global-set-key "\M-q" 'query-replace)
	 ;(global-set-key "\M-r" 'replace-string)
	 ;(global-set-key "\M-i" 'indent-region)
** Matcha
Global hydra from [[https://github.com/jojojames/matcha][Matcha github]] but no idea how good. I didn't want it all but that was the easiest.
Also see [[https://github.com/jerrypnz/major-mode-hydra.el][Major mode hydra]] for similar but grabs a major mode hydra from somewhere. Actually it is more like my H-a but automated it looks for

Major mode was missing the last line - I suspect due to echo area or possibly this bug https://github.com/abo-abo/hydra/issues/331

So ended up with matcha again and transient

And that works - I do need to edit the matcha files etc.
But transient needs a actual function that exists hydra can lazy load.
*** Matcha space the root matcha
**** Note on unused or other changes
**** quickrun
	  runs the current buffer through a compiler or interpreter. There are also functions to do for a method. Includes C, Racket, Python, Julia Although seems to have disappeared.
See https://github.com/syohex/emacs-quickrun but assumes a lot. Better look at org mode and repls.

   #+begin_src emacs-lisp
   (bind-key "H-d" 'matcha-run-mode-command)
   ;(bind-key "H-`" 'matcha-me-space)
   #+end_src
**
*** Hydra org
	Note there is also a transient mode
	#+begin_src emacs-lisp
	(define-transient-command mwb/matcha-org-space
	  "Org"
	  [["Org"
		("a" "Agenda" org-agenda)
		("c" "Capture" org-capture)
		("r" "Refile" org-refile)
		("t" "Todo" org-todo)]
	   ["Links"
		("l" "Store" org-store-link)
		("i" "Insert" org-insert-link)]
	   ["Subtree"
		("x" "Cut" org-cut-subtree)
		("w" "Copy" org-copy-subtree)
		("y" "Paste" org-paste-subtree)
		("Y" "Yank" org-yank)
		("W" "Clone" org-clone-subtree-with-time-shift)]
	   ])
	#+end_src
*** Hydra transpose
	From hydra wiki
	#+begin_src emacs-lisp
(defhydra hydra-transpose (:color red)
    "Transpose"
     ("c" transpose-chars "characters")
     ("w" transpose-words "words")
     ("o" org-transpose-words "Org mode words")
     ("l" transpose-lines "lines")
     ("s" transpose-sentences "sentences")
     ("e" org-transpose-elements "Org mode elements")
     ("p" transpose-paragraphs "paragraphs")
     ("t" org-table-transpose-table-at-point "Org mode table")
     ("q" nil "cancel" :color blue))
	#+end_src
** Kitchin hydras
   From [[https://kitchingroup.cheme.cmu.edu/blog/2015/09/28/A-cursor-goto-hydra-for-emacs/][Kitchin Group]] Original has helm and I add some from Hydra Wiki
*** Navigate
	#+begin_src emacs-lisp
(defhydra hydra-navigate (:color red
                          :hint nil)
  "
_f_: forward-char       _w_: forward-word       _n_: next-line
_b_: backward-char      _W_: backward-word      _p_: previous-line
^ ^                     _o_: subword-right      _,_: beginning-of-line
^ ^                     _O_: subword-left       _._: end-of-line

_s_: forward sentence   _a_: forward paragraph  _g_: forward page
_S_: backward sentence  _A_: backward paragraph _G_: backward page

 _B_: buffer list       _i_: window
_<left>_: previous buffer   _<right>_: next buffer
_<up>_: scroll-up           _<down>_: scroll-down

_[_: backward-sexp _]_: forward-sexp
_<_ beginning of buffer _>_ end of buffer _m_: set mark _/_: jump to mark
"
  ("f" forward-char)
  ("b" backward-char)
  ("w" forward-word)
  ("W" backward-word)
  ("n" next-line)
  ("p" previous-line)
  ("o" subword-right)
  ("O" subword-left)
  ("s" forward-sentence)
  ("S" backward-sentence)
  ("a" forward-paragraph)
  ("A" backward-paragraph)
  ("g" forward-page)
  ("G" backward-page)
  ("<right>" next-buffer)
  ("<left>" previous-buffer)
  ("i" ace-window :color blue)
  ("m" org-mark-ring-push)
  ("/" org-mark-ring-goto :color blue)
  ("B" counsel-buffers)
  ("<up>" scroll-up)
  ("<down>" scroll-down)
  ("<" beginning-of-buffer)
  (">" end-of-buffer)
  ("." end-of-line)
  ("[" backward-sexp)
  ("]" forward-sexp)
  ("," beginning-of-line)
  ("q" nil "quit" :color blue))

(bind-key "H-m" 'hydra-navigate/body)
	#+end_src
*** Goto
	#+begin_src emacs-lisp
	(defhydra goto (:color blue :hint nil)
	  "
	Goto:
	^Char^              ^Word^                ^search^
	^^^^^^^^--------------------------------------------------
	_c_: 2 chars        _w_: word by char     _f_: search forward
	_C_: char           _W_: some word        _b_: search backward
	_L_: char in line   _s_: subword by char  _B_: counsel-buffers
	_l_: avy-goto-line  _S_: some subword     _R_: counsel-recentf
	_i_: ace-window
	_n_: Navigate       _._: mark position    _/_: jump to mark
	----------------------------------------------------------
	"
	  ("c" avy-goto-char-2)
	  ("C" avy-goto-char)
	  ("L" avy-goto-char-in-line)
	  ("w" avy-goto-word-1)
	  ;; jump to beginning of some word
	  ("W" avy-goto-word-0)
	  ;; jump to subword starting with a char
	  ("s" avy-goto-subword-1)
	  ;; jump to some subword
	  ("S" avy-goto-subword-0)

	  ("l" avy-goto-line)
	  ("i" ace-window)

	  ;; ("h" helm-org-headlines)
	  ;; ("a" helm-org-agenda-files-headings)
	  ;; ("q" helm-multi-swoop-org)

	  ;; ("o" helm-occur)
	  ;; ("p" swiper-helm)

	  ("f" isearch-forward)
	  ("b" isearch-backward)

	  ("." org-mark-ring-push :color red)
	  ("/" org-mark-ring-goto :color blue)
	  ("B" ibuffer)
	  ;; ("m" helm-mini)
	  ("R" counsel-recentf)
	  ("n" hydra-navigate/body))

	(bind-key "H-g" 'goto/body)
	#+end_src
** Control x binding
   From [[https://github.com/abo-abo/hydra/wiki/Emacs][Hydra wiki - Find file with xf]]

** Hyper global key bindings
#+begin_src emacs-lisp
(bind-key (kbd "H-1")  'delete-other-windows osx-key-mode-map)
(bind-key (kbd "H-0")  'delete-window osx-key-mode-map)
;; H-a is major mode specific Hydra so bound to mode keymap by use-packag :hydra
;; (bind-key (kbd "H-h") 'hydra-space/body)
(bind-key (kbd "H-n") 'tabbar-move-current-buffer-to-new-frame osx-key-mode-map)
;; H-r is register
;; H-s is return from org special edit
;;(bind-key (kbd "H-t") 'treemacs osx-key-mode-map)
(bind-key "H-<return>" 'cua-set-rectangle-mark cua-global-keymap)
(unbind-key "C-<return>" cua-global-keymap)
#+end_src
** Command key bindings
These should be mac based adding to Aquamacs but some I do not used.
Note that the Aquamacs binding does not fit through bind-keys
#+begin_src emacs-lisp
(bind-key "A-/" 'comment-or-uncomment-region-or-line)
(bind-key "A-<kp-add>" 'zoom-font)
(bind-key "A-<kp-subtract>" 'zoom-font-out)
#+end_src
