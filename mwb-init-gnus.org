#+TITLE Emacs configuration gnus
#+PROPERTY:header-args :cache yes :tangle yes  :comments link

#+STARTUP: content

#+begin_src emacs-lisp
(setq gnus-read-active-file nil)
(setq gnus-use-adaptive-scoring t)
(setq gnus-default-adaptive-score-alist
	  '((gnus-unread-mark)
		(gnus-ticked-mark (subject 10))
		(gnus-killed-mark (subject -5))
		(gnus-catchup-mark (subject -1))))
(setq user-full-name "Mark Bestley")
(setq user-mail-address "gnus@bestley.co.uk")

(setq gnus-visual t
	  gnus-large-newsgroup 4000)

(defun exit-gnus-on-exit ()
  (if (and (fboundp 'gnus-group-exit)
		   (gnus-alive-p))
	  (with-current-buffer (get-buffer "*Group*")
		(let (gnus-interactive-exit)
		  (gnus-group-exit)))))

(add-hook 'kill-emacs-hook 'exit-gnus-on-exit)
#+end_src

* Backups
Well turn them off
#+begin_src emacs-lisp
(defun turn-off-backup ()
  (set (make-local-variable 'backup-inhibited) t))
(add-hook 'nnfolder-save-buffer-hook 'turn-off-backup)
#+end_src

* Servers
  #+begin_src emacs-lisp
  (setq gnus-select-method '(nntp "localhost"))
  (setq gnus-secondary-select-methods  '((nntp "news.gmane.org")))
  #+end_src
* Group buffer
Put groups in order by my ranking (comes from NeXT news setup
  #+begin_src emacs-lisp
  (setq gnus-group-sort-function 'gnus-group-sort-by-rank)
  #+end_src
* Summary buffer
** Threads
   Collapse threads when entering a group
   #+begin_src emacs-lisp
   (add-hook 'gnus-summary-prepared-hook 'gnus-summary-hide-all-threads)
   #+end_src
   #+begin_src emacs-lisp
   (setq gnus-fetch-old-headers 'some               ; Try to connect threads with the minimum number of old headers
		 gnus-build-sparse-threads 'some            ; Include not-received articles too with References:
		 gnus-summary-gather-subject-limit 'fuzzy   ; Use a smart fuzzy Subject-matcher
		 gnus-summary-thread-gathering-function 'gnus-gather-threads-by-references ; Use the References: header to thread root by dummy-article-creation
		 gnus-treat-display-smileys nil             ; Urgh. You must be joking.
		 gnus-thread-ignore-subject t               ; Ignore Subject: changes

		 gnus-thread-hide-killed t)                 ; Hiding propagates to subtrees
   #+end_src
** Sort Order
   Push the threads with bigger score on top of the buffer
   #+begin_src emacs-lisp
   (setq gnus-thread-sort-functions
		 '(gnus-thread-sort-by-number
		   (not gnus-thread-sort-by-date)		; Dates matter...
		   gnus-thread-sort-by-total-score))
   #+end_src
** Tree
 #+begin_src emacs-lisp
 (setq gnus-use-trees t
	   gnus-generate-tree-function 'gnus-generate-horizontal-tree
	   gnus-tree-minimize-window nil)
 (gnus-add-configuration
  '(article
	(vertical 1.0
			  (horizontal 0.25
						  (summary 0.75 point)
						  (tree 1.0))
			  (article 1.0))))

 (setq gnus-thread-hide-subtree
	   '(or gnus-article-unread-p
			gnus-article-unseen-p))
 #+end_src
** Prettify tree
From [[http://doc.rix.si/cce/cce-gnus.html][Here]]
#+begin_src emacs-lisp
(setq gnus-summary-line-format "%*%U%R%z%3t%4i %4V %(%&user-date; %-15,15f  %B%s%)\n"

	  gnus-sum-thread-tree-false-root ""
	  gnus-sum-thread-tree-indent " "
	  gnus-sum-thread-tree-leaf-with-other "├► "
	  gnus-sum-thread-tree-root ""
	  gnus-sum-thread-tree-single-leaf "╰► "
	  gnus-sum-thread-tree-vertical "│"
	  gnus-user-date-format-alist '((t . "%d %b %Y %H:%M")))
#+end_src
* Article buffer
  #+begin_src emacs-lisp
  (setq gnus-single-article-buffer t
		mm-text-html-renderer 'shr)
  #+end_src
* Old setup
Bin it
#+begin_src emacs-lisp :tangle no
;; GNUS
; gmail
(require 'gnus )
	


(add-to-list 'gnus-secondary-select-methods 
			 '(nnimap "gmail"
					  (nnimap-address "imap.gmail.com")
					  (nnimap-server-port 993)
					  (nnimap-stream ssl))
)
;; (add-to-list 'gnus-secondary-select-methods 
;; 			 '(nnimap "by2"
;; 					  (nnimap-address "imap4.blueyonder.co.uk")
;; 					  (nnimap-server-port 143)
;; 					  )
;; )
(setq user-full-name "Mark Bestley")
(setq user-mail-address "gnus@bestley.co.uk")

(setq message-send-mail-function 'smtpmail-send-it)
(setq message-send-mail-function 'smtpmail-send-it
      smtpmail-starttls-credentials '(("smtp.gmail.com" 587 nil nil))
      smtpmail-auth-credentials '(("smtp.gmail.com" 587 "mark.bestley@googlemail.com" nil))
      smtpmail-default-smtp-server "smtp.gmail.com"
      smtpmail-smtp-server "smtp.gmail.com"
      smtpmail-smtp-service 587
      smtpmail-local-domain "bestley.co.uk")





;; mime from http://www.emacswiki.org/emacs/MimeTypesWithGnus
;; Inline images?
(setq mm-attachment-override-types '("image/.*"))



;; No HTML mail
(setq mm-discouraged-alternatives '("text/html" "text/richtext"))
(defun my-gnus-summary-view-html-alternative-in-browser ()
      "Display the HTML part of the current multipart/alternative MIME message
    in OmniWeb."
      (interactive)
      (save-current-buffer
        (gnus-summary-show-article)
        (set-buffer gnus-article-buffer)
        (let ((file (make-temp-file "html-message-" nil ".html"))
              (handle (nth 3 (assq 1 gnus-article-mime-handle-alist))))
          (mm-save-part-to-file handle file)
          (browse-url (concat "file://" file)))))


(define-key gnus-summary-mode-map [?K ?M]
  'my-gnus-summary-view-html-alternative-in-browser)



(setq nnimap-split-inbox
        '("INBOX" ))

(setq nnimap-split-rule '(("by2" ("INBOX" nnimap-split-fancy))
                          ("gmail" ("INBOX" nnimap-split-fancy))))
(setq nnimap-split-predicate "UNDELETED")
(setq nnimap-split-fancy ;; (1)
	  '(|                                ;; (2) begin a split list
	;;	(: gnus-registry-split-fancy-with-parent) ;; (3)
		;; splitting rules go here       ;; (4)

;; accu seems to have an issue
;;		("List-Id" ".*accu-general.*" "lists.accugeneral.new" )


;; we have size problems
 		("List-Id" ".*<\\(.+\\)\\.lists\\.mysociety\\.org>.*" "lists.\\1\\.mysociety")

		("List-Id" ".*<\\(.+\\)\\.googlegroups\\.com>.*" "lists.\\1\\.gg")

		("List-Id" ".*<\\(.+\\)>.*" "lists.\\1")

	;; old yahoo  has no List Id - nore does apple
		(any "\\b\\(\\w+\\)@yahoogroups\\.com" "lists.yahoo.\\1")
		(any "\\b\\(\\w+\\)@lists\\.apple\\.com" "lists.apple.\\1")

		;; Rules to hit the various google groups. We're having
		;; problems with dashes, so we have to expand these
	;; my fail	(any  "<\\(.*\\)\\.googlegroups\\.com>" "lists.google.\\1")

	;	(any "\\b\\(\\w+\\)-\\b\\(\\w+\\)@googlegroups.com" "lists.google.\\1-\\2")
	;	(any "\\b\\(\\w+\\)@googlegroups\\.com" "lists.google.\\1")
		(from "calendar-notification" "calendar" )
		(to "moneywell@bestley.co.uk" "moneywell" )

		; note also the subject has to have waf in it - but wait until I join more projects
		(from "codesite-noreply@google.com" 
			  (|
			   ("subject" "waf" "lists.waf-users.gg")
			   "unfiled"
			   )
			  )
		"unfiled"                          ;; (5)
        )
)


#+end_src
